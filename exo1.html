<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tableau de Présence</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rapports</title>
    <link rel="stylesheet" href="assets/style.css" />
    <!-- Include jQuery and Chart.js libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <body>
    <header class="site-header">
      <nav class="navbar">
        <a class="brand" href="index.html">Assiduité</a>
        <button class="nav-toggle" aria-label="Basculer la navigation">☰</button>
        <ul class="nav-links">
          <li><a href="index.html">Accueil</a></li>
          <li><a href="exo1.html">Liste d'assiduité</a></li>
          <li><a href="exo2.html">login</a></li>
      <li><a href="login.html">Ajouter étudiant</a></li>
          <li><a href="logout.html">Déconnexion</a></li>
        </ul>
      </nav>
    </header>
    <main class="container">
      
      <p class="muted">Bienvenue consultez les statistiques détaillées, générez des graphiques
et analysez l’évolution de l’assiduité.</p>
    </main>
    
  <style>
    body {font-family: Arial, sans-serif;
      background: #f9f9f9;
      padding: 20px;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 1200px;
      margin: auto;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 8px;
    }

    th {
      background: #f2f2f2;
      font-weight: bold;
    }

    .col-last, .col-first {
      text-align: left;
      padding-left: 10px;
      font-weight: 600;
    }

    input[type="checkbox"] {
      transform: scale(1.2);
      cursor: pointer;
    }

    td input {
      margin: 0 auto;
      display: block;
    }

    /* Dynamic colors */
    .green-row td { background-color: #d4edda !important; }   /* good */
    .yellow-row td { background-color: #fff3cd !important; }  /* warning */
    .red-row td { background-color: #f8d7da !important; }     /* excluded */
    /* We handle row hover highlighting via jQuery below */
   
      /* === Style général === */
body {
  font-family: Arial, sans-serif;
  background-color: #f2f2f2;
  margin: 0;
  padding: 0;
}

/* === Header / Navbar === */
.site-header {
  background-color: #4CAF50;
  color: white;
  padding: 20px 0;
}

.navbar {
  max-width: 1100px;
  margin: auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
}

.brand {
  font-size: 1.5rem;
  color: white;
  text-decoration: none;
  font-weight: bold;
}

/* Bouton toggle mobile */
.nav-toggle {
  background: none;
  border: none;
  font-size: 26px;
  cursor: pointer;
  color: white;
  display: none; /* caché sur desktop */
}

/* Liens de menu */
.nav-links {
  list-style: none;
  display: flex;
  gap: 20px;
  margin: 0;
  padding: 0;
}

.nav-links a {
  color: white;
  text-decoration: none;
  padding: 10px 14px;
  border-radius: 5px;
  transition: background-color 0.3s;
}

.nav-links a:hover,
.nav-links a[aria-current="page"] {
  background-color: #45a049;
}

/* === Mobile: menu burger === */
@media (max-width: 768px) {
  .nav-toggle {
    display: block;
  }

  .nav-links {
    display: none;
    flex-direction: column;
    background-color: #4CAF50;
    width: 100%;
    padding: 10px 0;
  }

  .nav-links.open {
    display: flex;
  }

  .nav-links li {
    margin: 10px 0;
  }
}

/* === Contenu principal === */
.container {
  max-width: 900px;
  margin: 50px auto;
  text-align: center;
  padding: 20px;
}

h1 {
  margin-top: 0;
  color: #333;
}

.muted {
  color: #555;
  font-size: 1.1rem;
}

/* === Footer === */
footer {
  margin-top: 60px;
  background-color: #333;
  color: white;
  text-align: center;
  padding: 12px;
}

  </style>
</head>
<body>

  <h2>Tableau de Présence Dynamique</h2>

  <!-- Controls for reports, highlighting, searching and sorting -->
  <div id="controls" style="text-align:center; margin-bottom:20px;">
    <button id="showReportBtn">Show Report</button>
    <button id="highlightExcellentBtn">Highlight Excellent Students</button>
    <button id="resetColorsBtn">Reset Colors</button>
    <br /><br />
    <label for="searchInput">Search by Name:</label>
    <input type="text" id="searchInput" placeholder="Enter name">
    <button id="sortAbsBtn">Sort by Absences (Ascending)</button>
    <button id="sortPartBtn">Sort by Participation (Descending)</button>
    <p id="sortMessage" style="margin-top:10px;"></p>
  </div>

  <table id="attendanceTable">
    <thead>
      <tr>
        <th rowspan="2">Last Name</th>
        <th rowspan="2">First Name</th>
        <th colspan="2">S1</th>
        <th colspan="2">S2</th>
        <th colspan="2">S3</th>
        <th colspan="2">S4</th>
        <th colspan="2">S5</th>
        <th colspan="2">S6</th>
        <th rowspan="2">Absences</th>
        <th rowspan="2">Participation</th>
        <th rowspan="2">Message</th>
      </tr>
      <tr>
        <th>P</th><th>Pa</th>
        <th>P</th><th>Pa</th>
        <th>P</th><th>Pa</th>
        <th>P</th><th>Pa</th>
        <th>P</th><th>Pa</th>
        <th>P</th><th>Pa</th>
      </tr>
    </thead>

    <tbody>
      <tr>
        <td>Ahmed</td>
        <td>Sara</td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td class="abs">0</td>
        <td class="part">0</td>
        <td class="msg"></td>
      </tr>

      <tr>
        <td>Yacine</td>
        <td>Ali</td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td class="abs">0</td>
        <td class="part">0</td>
        <td class="msg"></td>
      </tr>
      <tr>
        <td>Houcine</td>
        <td>Rania</td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td><input type="checkbox" class="p"></td><td><input type="checkbox" class="pa"></td>
        <td class="abs">0</td>
        <td class="part">0</td>
        <td class="msg"></td>
      </tr>
    </tbody></table>

  <!-- Section to display report results -->
  <div id="reportSection" style="max-width:600px;margin:20px auto;display:none;">
    <h3>Attendance Report</h3>
    <canvas id="reportChart"></canvas>
    <p id="reportSummary" style="text-align:center;margin-top:10px;"></p>
  </div>

  <script>
    const table = document.getElementById("attendanceTable");

    // Fonction qui met à jour les absences et participations
    function updateRow(row) {
      const absencesCell = row.querySelector(".abs");
      const partCell = row.querySelector(".part");
      const msgCell = row.querySelector(".msg");

      const pBoxes = row.querySelectorAll(".p");
      const paBoxes = row.querySelectorAll(".pa");

      const totalSessions = pBoxes.length;
      const presentCount = [...pBoxes].filter(p => p.checked).length;
      const absences = totalSessions - presentCount;
      const participation = [...paBoxes].filter(p => p.checked).length;

      absencesCell.textContent = absences;
      partCell.textContent = participation;

      row.classList.remove("green-row", "yellow-row", "red-row");

      if (absences < 3) {
        row.classList.add("green-row");
        msgCell.textContent = "Good attendance – Excellent participation";
      } else if (absences >= 3 && absences <= 4) {
        row.classList.add("yellow-row");
        msgCell.textContent = "Warning – attendance low – You need to participate more";
      } else {
        row.classList.add("red-row");
        msgCell.textContent = "Excluded – too many absences – You need to participate more";
      }
    }

    // Activation sur les étudiants déjà présents
    table.querySelectorAll("input[type=checkbox]").forEach(box => {
      box.addEventListener("change", e => {
        const row = e.target.closest("tr");
        updateRow(row);
      });
    });

    // ---------------- Ajout automatique des étudiants ----------------

    // Ajouter une nouvelle ligne pour un étudiant
    function addStudentRow(student) {
      const tbody = table.querySelector("tbody");
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${student.lastName}</td>
        <td>${student.firstName}</td>
        ${Array(6).fill('').map(() => `
          <td><input type="checkbox" class="p"></td>
          <td><input type="checkbox" class="pa"></td>
        `).join('')}
        <td class="abs">0</td>
        <td class="part">0</td>
        <td class="msg"></td>
      `;

      tbody.appendChild(row);

      // Activer le calcul dynamique sur la nouvelle ligne
      row.querySelectorAll("input[type=checkbox]").forEach(box => {
        box.addEventListener("change", e => updateRow(row));
      });
    }

    // Charger les étudiants ajoutés via addStudent.html
    function loadStudents() {
      const students = JSON.parse(localStorage.getItem('students')) || [];
      const tbody = document.querySelector("#attendanceTable tbody");

      students.forEach(student => {
        const exists = [...tbody.querySelectorAll("tr")].some(r =>
          r.cells[0].textContent === student.lastName &&
          r.cells[1].textContent === student.firstName
        );
        if (!exists) addStudentRow(student);
      });
    }

    // Charger les étudiants au démarrage
    loadStudents();
    // Écoute les ajouts en direct sans actualisation
    window.addEventListener("storage", () => {
      loadStudents();
    });
    
$(document).ready(function() {
    // Highlight row on hover
    $("#attendanceTable tbody").on("mouseenter", "tr", function() {
        $(this).css("background-color", "#cce5ff");
    }).on("mouseleave", "tr", function() {
        $(this).css("background-color", "");
    });

    // Show student's full name and number of absences on click (ignore clicks on checkboxes)
    $("#attendanceTable tbody").on("click", "tr", function(e) {
        // If the click originates in a cell that contains a checkbox (or the checkbox itself), ignore
        const td = $(e.target).closest('td');
        if (td.find('input[type=checkbox]').length > 0) {
            return;
        }
        const firstName = $(this).children().eq(1).text();
        const lastName = $(this).children().eq(0).text();
        const absences = $(this).find(".abs").text();
        alert(`Student: ${firstName} ${lastName}\nAbsences: ${absences}`);
    });

    // Show Report button functionality
    $("#showReportBtn").on("click", function() {
        const rows = $("#attendanceTable tbody tr");
        const totalStudents = rows.length;
        let presentCount = 0;
        let participateCount = 0;

        rows.each(function() {
            const pBoxes = $(this).find(".p");
            const paBoxes = $(this).find(".pa");
            const isPresent = pBoxes.is(':checked');
            const isParticipate = paBoxes.is(':checked');
            if (isPresent) presentCount++;
            if (isParticipate) participateCount++;
        });

        // Update summary text
        $("#reportSummary").text(
            `Total Students: ${totalStudents}, Present: ${presentCount}, Participated: ${participateCount}`
        );

        // Draw a simple bar chart using Canvas API (no external dependencies)
        const canvas = document.getElementById('reportChart');
        const ctx = canvas.getContext('2d');
        // Set canvas dimensions
        const width = canvas.width = 400;
        const height = canvas.height = 250;
        // Data for bars
        const values = [totalStudents, presentCount, participateCount];
        const labels = ['Total', 'Present', 'Participated'];
        const maxVal = Math.max(...values, 1);
        const barWidth = width / values.length;
        // Clear previous drawing
        ctx.clearRect(0, 0, width, height);
        // Set font for labels
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        // Draw each bar
        values.forEach((val, i) => {
            const barHeight = (val / maxVal) * (height - 50);
            const x = i * barWidth + barWidth * 0.15;
            const barActualWidth = barWidth * 0.7;
            const y = height - barHeight - 20;
            // Bar color (simple neutral color)
            ctx.fillStyle = '#888';
            ctx.fillRect(x, y, barActualWidth, barHeight);
            // Draw value above bar
            ctx.fillStyle = '#000';
            ctx.fillText(val.toString(), x + barActualWidth / 2, y - 5);
            // Draw label below bar
            ctx.fillText(labels[i], x + barActualWidth / 2, height - 5);
        });

        $("#reportSection").show();
    });

    // Highlight Excellent Students button functionality
    $("#highlightExcellentBtn").on("click", function() {
        $("#attendanceTable tbody tr").each(function() {
            const absences = parseInt($(this).find(".abs").text(), 10);
            if (absences < 3) {
                // animate background color change for excellent students
                $(this).css('transition','background-color 1s');
                $(this).css('background-color','#b3ffcc');
            }
        });
    });

    // Reset Colors button functionality
    $("#resetColorsBtn").on("click", function() {
        $("#attendanceTable tbody tr").each(function() {
            $(this).css('background-color','');
        });
    });

    // Search by name functionality
    $("#searchInput").on("keyup", function() {
        const searchTerm = $(this).val().toLowerCase();
        $("#attendanceTable tbody tr").filter(function() {
            const last = $(this).children().eq(0).text().toLowerCase();
            const first = $(this).children().eq(1).text().toLowerCase();
            $(this).toggle(last.includes(searchTerm) || first.includes(searchTerm));
        });
    });

    // Sort by Absences (Ascending)
    $("#sortAbsBtn").on("click", function() {
        const rows = $("#attendanceTable tbody tr").get();
        rows.sort(function(a, b) {
            const absA = parseInt($(a).find(".abs").text(), 10);
            const absB = parseInt($(b).find(".abs").text(), 10);
            return absA - absB;
        });
        $.each(rows, function(index, row) {
            $("#attendanceTable tbody").append(row);
        });
        $("#sortMessage").text("Sorted by Absences (Ascending)");
    });

    // Sort by Participation (Descending)
    $("#sortPartBtn").on("click", function() {
        const rows = $("#attendanceTable tbody tr").get();
        rows.sort(function(a, b) {
            const partA = parseInt($(a).find(".part").text(), 10);
            const partB = parseInt($(b).find(".part").text(), 10);
            return partB - partA;
        });
        $.each(rows, function(index, row) {
            $("#attendanceTable tbody").append(row);
        });
        $("#sortMessage").text("Sorted by Participation (Descending)");
    });
});
     const toggle = document.querySelector('.nav-toggle');
      const links = document.querySelector('.nav-links');
      toggle?.addEventListener('click', () => links.classList.toggle('open'));
   
</script>
  

</body>
</html>